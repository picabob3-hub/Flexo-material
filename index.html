<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest_costos.json">
    <meta name="theme-color" content="#4a148c">
    <title>Calculadora de Producci√≥n</title>
    <style>
        :root { --p-color: #4a148c; --bg: #f8f9fa; --u-color: #0d47a1; }
        body { font-family: sans-serif; background: var(--bg); margin: 0; padding: 10px; color: #333; }
        .container { max-width: 500px; margin: 0 auto; background: white; padding: 15px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); position: relative; }
        
        .header-strip { background-color: var(--p-color); height: 45px; border-radius: 8px; margin-bottom: 15px; display: flex; align-items: center; padding: 0 15px; }
        .settings-gear { cursor: pointer; color: white; font-size: 24px; }
        
        /* Panel de Configuraci√≥n */
        .logo-config-panel { 
            display: none; position: absolute; top: 55px; left: 5px; right: 5px;
            background: white; border: 1px solid #ddd; padding: 15px; border-radius: 12px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.3); z-index: 101; max-height: 85vh; overflow-y: auto;
        }
        .config-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        
        /* Bot√≥n X Minimalista */
        .btn-close-x { background: #f0f0f0; color: #999; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 14px; cursor: pointer; transition: 0.2s; }
        .btn-close-x:hover { background: #e0e0e0; color: #666; }
        
        .config-section { border-bottom: 1px solid #eee; margin-bottom: 15px; padding-bottom: 10px; }
        .config-section h4 { margin: 0; color: var(--p-color); font-size: 16px; border-left: 4px solid var(--p-color); padding-left: 8px; }
        .config-grid { display: flex; flex-direction: column; gap: 12px; margin-top: 10px; }
        .config-item { display: flex; flex-direction: column; }
        .config-item label { font-size: 10px; color: #666; font-weight: bold; margin-bottom: 4px; }
        .config-item input { padding: 8px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
        
        input:disabled { background: #f0f0f0; color: #999; border: 1px dashed #ccc; }

        #logo-preview { max-width: 180px; max-height: 90px; object-fit: contain; margin-bottom: 10px; display: none; }
        .logo-container { text-align: left; width: 100%; }

        h2 { border-bottom: 2px solid #eee; padding-bottom: 5px; font-size: 1em; text-transform: uppercase; color: var(--p-color); margin-top: 20px; }
        .grid-inputs { display: flex; flex-direction: column; gap: 12px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-weight: bold; color: #444; margin-bottom: 4px; font-size: 0.85em; }
        input { padding: 12px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; background: #fff; text-align: right; }
        
        .res-valor { padding: 10px; border-radius: 8px; font-weight: bold; text-align: right; font-size: 15px; margin-bottom: 4px; }
        .res-blue { background-color: #e3f2fd; color: #0d47a1; }
        .res-purple { background-color: #f3e5f5; color: #4a148c; }
        .res-green { background-color: #e8f5e9; color: #1b5e20; }

        .material-selector { background: #f9f4ff; padding: 10px; border-radius: 10px; margin-top: 10px; border: 1px solid #e1bee7; }
        .material-option { display: grid; grid-template-columns: 35px 1fr; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid #eee; }

        .total-box { background: #e8f5e9; padding: 15px; border-radius: 12px; text-align: right; border: 2px solid #c8e6c9; margin-top: 15px; }
        .total-val { font-size: 28px; font-weight: bold; color: #1b5e20; }
        
        .ajuste-info { font-size: 0.85em; font-weight: bold; padding: 8px; border-radius: 8px; margin-bottom: 10px; display: block; text-align: center; }
        .recargo { background: #fff5f5; color: #c53030; border: 1px solid #feb2b2; }
        .descuento { background: #f0fff4; color: #2f855a; border: 1px solid #9ae6b4; }

        .solo-print { display: none; }

        @media print {
            .no-print, button, .header-strip, .logo-config-panel, .material-selector, h2, hr, .ajuste-info { display: none !important; }
            body { background: white; margin: 0; padding: 0; width: 100%; }
            .container { box-shadow: none; border: none; padding: 10mm; width: 100% !important; max-width: 100% !important; box-sizing: border-box; }
            .logo-container { text-align: left !important; margin-bottom: 10px; }
            #logo-preview { display: block !important; max-width: 180px; }
            .print-title { display: block !important; color: #e0e0e0 !important; font-size: 18pt; font-weight: bold; text-transform: uppercase; margin-bottom: 15px; letter-spacing: 2px; }
            .header-info-print { display: block !important; text-align: left !important; margin-bottom: 20px; }
            .input-group { border: none; margin-bottom: 4px; display: block !important; }
            .input-group label { display: inline-block; width: 70px; font-size: 9pt; color: #666; font-weight: bold; }
            input { border: none !important; text-align: left !important; font-size: 10pt !important; background: transparent !important; padding: 0 !important; width: auto !important; display: inline-block !important; }
            .solo-print.print-details { display: block !important; margin-bottom: 15px; font-size: 10pt; line-height: 1.5; border-top: 1px solid #eee; padding-top: 10px; width: 100%; }
            .total-box { background: none !important; border: none !important; border-top: 1.5px solid #000 !important; padding: 10px 0 !important; border-radius: 0; text-align: right; width: 100%; }
            .total-val { font-size: 20pt !important; color: #000 !important; }
            .print-footer-legal { display: block !important; margin-top: 20px; font-size: 6.5pt !important; text-align: left !important; line-height: 1.3; color: #444; width: 100%; }
            .signature-space { margin: 30px 0; text-align: center; width: 100%; }
            .signature-line { width: 160px; border-top: 1px solid #000; margin: 0 auto 5px auto; }
            .footer-contact { margin-top: 10px; font-size: 6.5pt !important; text-align: left !important; color: #555; width: 100%; }
        }
    </style>
</head>
<body>

<div class="container">
    <div class="logo-container"><img id="logo-preview" src=""></div>
    <div class="solo-print print-title">Proforma de Etiquetas</div>

    <div class="header-strip no-print">
        <span class="settings-gear" onclick="openConfig()">‚öô</span>
        <div id="config-panel" class="logo-config-panel">
            <div class="config-header">
                <span style="font-weight:bold; color:var(--p-color); font-size: 14px;">CONFIGURACI√ìN</span>
                <button class="btn-close-x" onclick="closeConfigWithoutSaving()">‚úï</button>
            </div>

            <div class="config-section">
                <h4>Empresa (Libre)</h4>
                <div class="config-item"><label>Cambiar Logo:</label><input type="file" accept="image/*" onchange="saveLogo(this)"></div>
            </div>

            <div class="config-section" id="lock-overlay">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <h4>Costos e Impuestos</h4>
                    <button id="btn-unlock" onclick="checkPass()" style="background:#f5f5f5; border:1px solid #ddd; padding:4px 8px; border-radius:4px; font-size:10px; color:#777; cursor:pointer;">üîì Desbloquear</button>
                </div>
                <div class="config-grid">
                    <div class="config-item"><label>IVA %:</label><input type="number" id="iva_p" value="15" disabled></div>
                    <div class="config-item"><label>P. Blanco:</label><input type="number" id="v1" value="0.00015783" step="0.000001" disabled></div>
                    <div class="config-item"><label>P. Trans.:</label><input type="number" id="v2" value="0.00015783" step="0.000001" disabled></div>
                    <div class="config-item"><label>P. Metal.:</label><input type="number" id="v3" value="0.00023805" step="0.000001" disabled></div>
                    <div class="config-item"><label>Propal. B:</label><input type="number" id="v4" value="0.0001669" step="0.000001" disabled></div>
                    <div class="config-item"><label>Propal. M:</label><input type="number" id="v5" value="0.0002169" step="0.000001" disabled></div>
                    <div class="config-item"><label>Manual:</label><input type="number" id="val_manual" value="0.000439" step="0.000001" disabled></div>
                </div>
            </div>
            <button onclick="saveAndClose()" style="width:100%; padding:14px; background:var(--p-color); color:white; border:none; border-radius:8px; font-weight:bold; cursor:pointer; margin-top: 5px;">üíæ GUARDAR CAMBIOS</button>
        </div>
    </div>

    <div class="header-info-print">
        <div class="input-group"><label>CLIENTE:</label><input type="text" id="c_nom" placeholder="..."></div>
        <div class="input-group"><label>RUC/CI:</label><input type="text" id="c_ruc" placeholder="..."></div>
        <div class="input-group"><label>FECHA:</label><input type="text" id="fecha"></div>
    </div>

    <div class="no-print">
        <h2>1. Datos de Producci√≥n</h2>
        <div class="grid-inputs">
            <div class="input-group"><label>Medida Bloque (cm):</label><input type="number" id="cm_bloque" value="22.25" oninput="calc()"></div>
            <div class="input-group"><label>Etiq x Bloque:</label><input type="number" id="etiq_bloque" value="6" oninput="calc()"></div>
            <div class="input-group"><label>Total Pedido:</label><input type="number" id="tot_etiq" value="5000" oninput="calc()"></div>
            <div class="input-group"><label>Ancho Material (cm):</label><input type="number" id="ancho_cm" value="10" oninput="calc()"></div>
        </div>

        <h2>2. M√©tricas T√©cnicas</h2>
        <div class="grid-inputs">
            <div class="input-group"><label>Bloques:</label><div id="res_bloques" class="res-valor res-blue">0</div></div>
            <div class="input-group"><label>Lineal (cm):</label><div id="res_cm" class="res-valor res-blue">0</div></div>
            <div class="input-group"><label>Superficie (cm¬≤):</label><div id="res_area_cm2" class="res-valor res-purple">0</div></div>
            <div class="input-group"><label>Metros (m):</label><div id="res_metros" class="res-valor res-green">0</div></div>
            <div class="input-group"><label>Pies (ft):</label><div id="res_pies" class="res-valor res-green">0</div></div>
        </div>

        <h2>3. Material y Extras</h2>
        <div class="material-selector">
            <div class="material-option"><input type="radio" name="mat" id="r1" checked onclick="calc()"><span>PoliP Blanco</span></div>
            <div class="material-option"><input type="radio" name="mat" id="r2" onclick="calc()"><span>PoliP Transparente</span></div>
            <div class="material-option"><input type="radio" name="mat" id="r3" onclick="calc()"><span>PoliP Metalizado</span></div>
            <div class="material-option"><input type="radio" name="mat" id="r4" onclick="calc()"><span>Propalcote Blanco</span></div>
            <div class="material-option"><input type="radio" name="mat" id="r5" onclick="calc()"><span>Propalcote Metalizado</span></div>
            <div class="material-option"><input type="radio" name="mat" id="radio_manual" onclick="calc()"><span>Manual</span></div>
        </div>
        <div class="input-group" style="margin-top:15px;">
            <label style="color:#888">Extra / Corte ($):</label>
            <input type="number" id="costo_extra" value="0" step="0.1" oninput="calc()" style="border: 1px solid #ddd; background: #fdfdfd;">
        </div>
    </div>

    <div class="solo-print print-details">
        <b>Cantidad:</b> <span id="p_cant">0</span> etiquetas<br>
        <b>Ancho Material:</b> <span id="p_ancho">0</span> cm<br>
        <b>Tipo de Material:</b> <span id="p_mat">-</span><br>
        <b>Medida Lineal:</b> <span id="p_lin">0</span> metros<br>
        <b>Superficie Total:</b> <span id="p_area">0</span> cm¬≤
    </div>

    <div class="total-box">
        <div id="msg_ajuste" class="ajuste-info no-print"></div>
        <div style="font-size:14px">SUBTOTAL: <span id="res_subtotal">$ 0.00</span></div>
        <div style="font-size:12px" id="label_iva">IVA: $ 0.00</div>
        <div class="total-val" id="res_total">$ 0.00</div>
    </div>

    <div class="solo-print print-footer-legal">
        <b>Validez de la oferta:</b> Vence el <span id="p_caduca"></span> (15 d√≠as)<br>
        <b>Forma de pago:</b><br>
        ‚Ä¢ 50% a la aprobaci√≥n de la proforma<br>
        ‚Ä¢ 50% contra entrega
        <div class="signature-space">
            <div class="signature-line"></div>
            <b>FIRMA DE GERENCIA</b>
        </div>
        <div class="footer-contact">
            Dir.: Av Atahualpa y Garc√≠a Mogrovejo esq<br>
            Telef.: 0987084163<br>
            Ambato - Ecuador
        </div>
    </div>

    <button class="btn-print no-print" onclick="window.print()" style="background:var(--p-color); color:white; border:none; width:100%; padding:16px; border-radius:10px; font-weight:bold; margin-top:20px;">üñ®Ô∏è IMPRIMIR PROFORMA</button>
</div>

<script>
    const ADMIN_PASS = "1234";

    window.onload = () => {
        const logo = localStorage.getItem('cirel_logo_permanente');
        if(logo) { document.getElementById('logo-preview').src = logo; document.getElementById('logo-preview').style.display = 'block'; }
        loadStoredData();
        const hoy = new Date();
        document.getElementById('fecha').value = hoy.toLocaleDateString();
        const caduca = new Date();
        caduca.setDate(hoy.getDate() + 15);
        document.getElementById('p_caduca').textContent = caduca.toLocaleDateString();
        calc();
    };

    function loadStoredData() {
        const ids = ['iva_p', 'val_manual', 'v1', 'v2', 'v3', 'v4', 'v5'];
        ids.forEach(id => {
            const val = localStorage.getItem('conf_' + id);
            if(val) document.getElementById(id).value = val;
        });
    }

    function openConfig() { document.getElementById('config-panel').style.display = 'block'; }

    function closeConfigWithoutSaving() {
        loadStoredData();
        document.getElementById('config-panel').style.display = 'none';
        document.querySelectorAll('#lock-overlay input').forEach(i => i.disabled = true);
        document.getElementById('btn-unlock').style.display = 'block';
        calc();
    }

    function saveAndClose() {
        const ids = ['iva_p', 'val_manual', 'v1', 'v2', 'v3', 'v4', 'v5'];
        ids.forEach(id => { localStorage.setItem('conf_' + id, document.getElementById(id).value); });
        document.getElementById('config-panel').style.display = 'none';
        document.querySelectorAll('#lock-overlay input').forEach(i => i.disabled = true);
        document.getElementById('btn-unlock').style.display = 'block';
        calc();
        alert("¬°Configuraci√≥n guardada!");
    }

    function checkPass() {
        const pass = prompt("Ingrese clave:");
        if (pass === ADMIN_PASS) {
            document.querySelectorAll('#lock-overlay input').forEach(i => i.disabled = false);
            document.getElementById('btn-unlock').style.display = 'none';
        } else if (pass !== null) { alert("Clave incorrecta."); }
    }

    function saveLogo(input) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = e => {
                localStorage.setItem('cirel_logo_permanente', e.target.result);
                document.getElementById('logo-preview').src = e.target.result;
                document.getElementById('logo-preview').style.display = 'block';
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function calc() {
        const cmB = parseFloat(document.getElementById('cm_bloque').value) || 0;
        const etB = parseFloat(document.getElementById('etiq_bloque').value) || 0;
        const totE = parseFloat(document.getElementById('tot_etiq').value) || 0;
        const ancho = parseFloat(document.getElementById('ancho_cm').value) || 0;
        const extra = parseFloat(document.getElementById('costo_extra').value) || 0;
        const ivaP = parseFloat(document.getElementById('iva_p').value) || 0;
        
        const sel = document.querySelector('input[name="mat"]:checked');
        const matNombre = sel.parentElement.querySelector('span').textContent;
        let costoBase = (sel.id === 'radio_manual') ? parseFloat(document.getElementById('val_manual').value) : parseFloat(document.getElementById('v' + sel.id.substring(1)).value);

        if (etB <= 0 || totE <= 0) return;

        const bloques = totE / etB;
        const totalCm = bloques * cmB;
        const areaCm2 = totalCm * ancho;

        document.getElementById('res_bloques').textContent = bloques.toFixed(2);
        document.getElementById('res_cm').textContent = totalCm.toFixed(2) + " cm";
        document.getElementById('res_area_cm2').textContent = areaCm2.toFixed(0) + " cm¬≤";
        document.getElementById('res_metros').textContent = (totalCm/100).toFixed(2) + " m";
        document.getElementById('res_pies').textContent = (totalCm/30.48).toFixed(2) + " ft";
        
        document.getElementById('p_cant').textContent = totE.toLocaleString();
        document.getElementById('p_ancho').textContent = ancho;
        document.getElementById('p_mat').textContent = matNombre;
        document.getElementById('p_lin').textContent = (totalCm/100).toFixed(2);
        document.getElementById('p_area').textContent = areaCm2.toFixed(0);

        let factorAjuste = 1.0;
        let mensaje = ""; let claseAjuste = "";
        if (totE <= 3000) { factorAjuste = 1.25; mensaje = "‚ö†Ô∏è Recargo 25% (Cant. M√≠nima)"; claseAjuste = "recargo"; }
        else if (totE <= 5000) { factorAjuste = 1.15; mensaje = "‚ö†Ô∏è Recargo 15% (Cant. Media)"; claseAjuste = "recargo"; }
        else if (totE >= 50000) { factorAjuste = 0.85; mensaje = "‚úÖ Descuento 15% (Gran Volumen)"; claseAjuste = "descuento"; }
        else if (totE >= 25000) { factorAjuste = 0.90; mensaje = "‚úÖ Descuento 10% (Volumen)"; claseAjuste = "descuento"; }

        const subtotal = (areaCm2 * (costoBase * factorAjuste)) + extra;
        const ivaVal = subtotal * (ivaP / 100);
        document.getElementById('res_subtotal').textContent = `$ ${subtotal.toFixed(2)}`;
        document.getElementById('label_iva').textContent = `IVA (${ivaP}%): $ ${ivaVal.toFixed(2)}`;
        document.getElementById('res_total').textContent = `$ ${(subtotal + ivaVal).toFixed(2)}`;
        
        const msgBox = document.getElementById('msg_ajuste');
        msgBox.textContent = mensaje; msgBox.className = "ajuste-info " + claseAjuste + " no-print";
        msgBox.style.display = mensaje ? "block" : "none";
    }
</script>
</body>
</html>
